---
title: "Final Project - Animal Shelter Analysis"
author: "Maya Mileva & Abraham Morales"
date: "9/9/2019"
output:
  prettydoc::html_pretty:
    highlight: tango
    theme: architect
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE, cache = FALSE)
```

```{r include=FALSE, echo=FALSE}
# Load the require packages
library(tidyverse)
library(RWeka)
library(partykit)
library(rpart)
library(rpart.plot)
library(plyr)
library(RColorBrewer)
library(philentropy)
library(factoextra)
library(caret)
library(arules)
library(RANN)
library(sjmisc)
library(e1071)
library(knitr)
library(kableExtra)
```

# Introduction

The Austin Animal Center is the largest no-kill animal shelter and shelters and protects over 18,000 animals each year. As part of the City of Austin's Open Data Initiative, the Center makes available their data detailing shelter pet intake and outcomes. According to the data portal, over 90% of animal outcomes are adoptions, transfers to other shelter partners or returning lost pets to owners. The questions we want to answer are: 

•	Is there a predictable pattern or visible trend to shelter pet outcomes?

•	What features are the best determinant for animal shelter outcomes?

•	What features are the best determinant for whater or not the animal is adopted?


We are analyzing a dataset of intakes and outcomes from Austin Animal Shelter to understand animal adoption trends, including which attributes of animals result in a higher likelihood of adoption. Our final goal is to predict whether or not an animal will be adopted based on characteristics Austin Animal shelter can identify upon intake.

# Data Set Overview

The data contains intakes and outcomes of animals entering the Austin Animal Center from the beginning of October 2013 to the present day. Outcomes represent the status of animals as they leave the Animal Center. All animals receive a unique Animal ID during intake.  The dataset contains over 79,672 observations with 45 variables. 40 of these variables and their descriptions are shown in the table below.

```{r dataDesc}
# Load Descriptions of Variables
varNames <- read_csv("C:/Users/darkl/OneDrive/Syracuse/Summer 2019/IST 707/_Group_Project/dataset_variable_descriptions.csv")

# Print rable with description of variables
kable(varNames)
```

## Load Data and Clean Up

We start by loading the dataset provided in the Kaggle link shown below.

Kaggle Link: https://www.kaggle.com/aaronschlegel/austin-animal-center-shelter-intakes-and-outcomes

This dataset has been pre-processed to split up the color variable into a primary_color, secondary_color, and multi_color variables. The remaining variables are processed to remove blank values. Similarly the animal breed variable has been split into primary_breed and secondary_breed variables to reduce the todal unique values from over 2,000 to ~350. We first load the data and identify variables with missing values.

```{r loadDaata}
## Load the data 
shelter = read.csv("C:/Users/darkl/OneDrive/Syracuse/Summer 2019/IST 707/_Group_Project/aac_intakes_outcomes_082819.csv", stringsAsFactors = FALSE)

## Exploring data set
kable(dim(shelter)) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

### Check for Missing Values

The data set is reviewed to identify any missing values.

```{r missVal}
## Check which columns are missing data. 
kable(apply(X = shelter,MARGIN = 2,FUN = function(x) (length(which(x == ''))))) %>%
  kable_styling(bootstrap_options = "striped",fixed_thead = T) %>% 
  scroll_box(height = "300px")
```

The outcome_type and sex_upon_intake variables have 11 missing variables. Due to the size of the dataset at 79,672 observations, we've opted to elimante these 11 rows in their entirety. Additionally the outcome_subtype variable has over 43,000 missing values. As this column had over 50% of missing values it will be removed from the data set.

### Remove Missing Values

```{r missValDel}
## Remove the missing values
shelter = shelter[-which(shelter$outcome_type == ''),]
shelter = shelter[-which(shelter$sex_upon_intake == ''),]
shelter <- shelter %>% select(-outcome_subtype)
```

### Verify Missing Values are Gone

We then varify there are no more missing values in our data set.

```{r}
shelter[is.na(shelter)] <- 0
```

### Review Data

And we take a peak ar the first three rows of the data set to ensure the outcome_subtype variable has been removed.

```{r peakTop3}
kable(head(shelter, n=3)) %>% 
  kable_styling("striped") %>% 
  scroll_box(width = "100%")
```

### Remove Redundant Variables

The dataset contains a series of redundant variables and also identification variables used by the animal shelter, but provide no information for building predictive models. These variables are listed below and have been removed from the data set leaving 21 to be used for exploratory analysis and building the predictive models.

```{r delVars}
## Remove unneccessary columns.
shelterC = shelter[,-which(colnames(shelter) %in% c('age_upon_outcome',
                                                    'animal_id_outcome',
                                                    'date_of_birth',
                                                    'outcome_subtype',
                                                    'age_upon_outcome_.days.',
                                                    'age_upon_outcome_age_group',
                                                    'outcome_monthyear',
                                                    'outcome_number',
                                                    'dob_year',
                                                    'dob_month',
                                                    'dob_monthyear',
                                                    'age_upon_intake',
                                                    'animal_id_intake',
                                                    'found_location',
                                                    'count',
                                                    'age_upon_intake_.days.',
                                                    'age_upon_intake_age_group',
                                                    'intake_datetime',
                                                    'intake_monthyear',
                                                    'intake_number',
                                                    'time_in_shelter',
                                                    'outcome_datetime',
                                                    'color',
                                                    'breed'))] 

# verify removal
kable(head(shelterC)) %>% 
  kable_styling("striped") %>% 
  scroll_box(width = "100%")
```

After removal of the empty values, outcome_subtype and redundant variables we are left with 79,661 observations and 21 variables.

# Exploratory Analysis

We then take a look at the overall numbers of the animals being admitted into the shelter and the distributions of their outcome based on animal type.

## Intakes by Animal Type

```{r plot1, fig.width=10, fig.height=8, include=FALSE}
# Color blind friendly color palette
cbPalette <- c("#999999", 
               "#E69F00", 
               "#56B4E9", 
               "#009E73", 
               "#F0E442", 
               "#0072B2", 
               "#D55E00", 
               "#CC79A7",
               "#E6AB02",
               "#A6761D",
               "#000000",
               "#D81B60")

# Sorting
shelterC$animal_type <- factor(shelterC$animal_type, levels = c("Dog","Cat","Other","Bird"))

## Plot animals by type
ggplot(shelterC, aes(x=animal_type, fill=animal_type)) + 
  geom_bar() + 
  scale_fill_manual(values=cbPalette) + 
  xlab("Animal Type") +
  ylab("Count of Animals") + 
  ggtitle("Distribution of Shelter intakes by Animal Type") +
  theme(plot.title = element_text(hjust = 0.5)) + 
  theme(legend.position = 'none')
```

In the "Distribution of Shelter outcomes and Animal Type" figure we see that the vast majority of animals accepted at the AAS are cats and dogs. With dogs being the  majority. Next we take a look at the distribution based on outcome type.

## Outcomes

```{r plot2, fig.width=10, fig.height=8, include=FALSE}
# Sorting
shelterC$outcome_type <- factor(shelterC$outcome_type, levels = c("Adoption",
                                                                  "Transfer",
                                                                  "Return to Owner",
                                                                  "Euthanasia",
                                                                  "Died",
                                                                  "Disposal",
                                                                  "Rto-Adopt",
                                                                  "Missing",
                                                                  "Relocate"))

## Plot distributions by outcome type
ggplot(data = shelterC) +
  geom_bar(mapping = aes(x = `outcome_type`, fill = `outcome_type`))+  scale_fill_manual(values=cbPalette)+
  ggtitle("Distribution of Shelter Outcomes") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Outcome Type") +
  ylab("Count of Animals") +
  theme(legend.position = 'none')
```

The figure also shows the most likely outcome to be adoption followed next by transfers and then returns to owners. There is a high number of euthanasia and the plot below shows that most of these observations are due to the “other” animal types noted in the dataset.

### Outcomes by Animal Type

```{r plot3, fig.width=10, fig.height=8}
## Histogram of animal type by outcomes
ggplot(data =shelterC) +
  geom_bar(mapping = aes(x = `animal_type`, fill = `outcome_type`))+
  scale_fill_manual(values=cbPalette) +
  ggtitle("Distribution of Shelter Outcomes and Animal Type") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Animal Type") +
  ylab("Count of Animals")
```

Lastly the figure above shows that more dogs are returned to owners than cats, but more dogs overall are adopted than cats. And cats of all animal types get transferred more often. We further break down this distribution into the individual populations to see the percentages of outcomes by animal type.

### Outcomes by Percent of Animal Population

```{r plot4, fig.width=10, fig.height=8, include=FALSE}
# Plot outcomes perentages faceted by animal type
ggplot(shelterC, aes(x=outcome_type, group=animal_type)) + 
  geom_bar(aes(y = ..prop.., fill = factor(..x..)),stat = "count") +
  geom_text(aes(label = scales::percent(..prop..),
                y = ..prop..), stat = "count", vjust = -.5) + 
  labs(y = "Percent", fill = "outcome_type") + 
  facet_grid(animal_type ~.) + 
  scale_y_continuous(labels = scales::percent, limits = c(0, 1)) +
  scale_fill_manual(values=cbPalette) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Population Percentages by Shelter Outcome and Animal Type") +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Outcome Type") +
  ylab("Percent of Animal's Population") +
  theme(legend.position = 'none')
```

We then begin to explore whether the age had an impact on outcome and if there's a relation to the animal color. The jitter plot below shows a drop off in adoptions and transfers for dogs after about 15 years of age. Though 15 years and older continue to be returned to owners. Additionally there does not seem to be a specific pattern with regards to animal color as we can see a good distribution of all colors across all ages and outcomes.

### Impact due to Age and Color

```{r plot5, fig.width=10, fig.height=8}
## Dogs outcome_tpe and year  for different colors
shelterC %>%
  filter(animal_type == "Dog") %>%
  ggplot(aes(x=outcome_type, y=age_upon_outcome_.years., col = primary_color))+
  geom_jitter(alpha = 0.5, width = 0.2)+facet_grid() + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Distribution of Dog Color vs. Age") +
  theme(plot.title = element_text(hjust = 0.5)) +  
  xlab("Outcome Type") +
  ylab("Age Upon Outcome [yrs]")
```

We then move on to see if adoptions had a relationship to what the sex of the animal was and whether or not the animal had been spayed or neutered. 

### Impact due to Age and Sex

```{r plot6, fig.width=10, fig.height=8,include=FALSE}
## Age and and sex for the adopted anumals
shelterC %>%
  filter(outcome_type == "Adoption") %>%
  ggplot(aes(x=animal_type, y=age_upon_outcome_.years., col = sex_upon_outcome))+
  geom_jitter(alpha = 0.5, width = 0.2)+facet_grid() +
  ggtitle("Sex Upon Outcome for Adopted Animals Only")  +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Animal Type") +
  ylab("Age Upon Outcome [yrs]")
```

No clear trend was present except for highlighting that the majority of cats and dogs adopted had been spayed or neutered regardless of age or sex. Even when expanded to all outcome types there did not appear to be a significant link to age and sex upon outcome. 

```{r plot7, fig.width=10, fig.height=8,include=FALSE}
## For animals with any outcome
shelterC %>%
  ggplot(aes(x=animal_type, y=age_upon_outcome_.years., col = sex_upon_outcome))+
  geom_jitter(alpha = 0.5, width = 0.2)+facet_grid() +
  ggtitle("Sex Upon Outcome for All Animals and Outcome Types")  +
  theme(plot.title = element_text(hjust = 0.5)) +
  xlab("Animal Type") +
  ylab("Age Upon Outcome [yrs]")
```

## Outcomes Over Time

We now take a look at the intakes and outcomes over time in terms of day of week, hour of day and month of the year.

### Day of Week

```{r table1}
# Sorting
shelterC$intake_weekday <- factor(shelterC$intake_weekday, levels = c("Monday",
                                                                  "Tuesday",
                                                                  "Wednesday",
                                                                  "Thursday",
                                                                  "Friday",
                                                                  "Saturday",
                                                                  "Sunday"))
## Day of the week
kable(count(shelterC,'intake_weekday')) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

The results show that the number of intakes on each of day the week is almost consistent. Saturday has the highest number but having said that, Monday isn't far behind and so we cannot really conclude that the animals intook on Saturday were dropped in by their owners. 

We also reviewed the time of day in which adoptions happen. 

### Hour of Day

```{r plot8, fig.width=10, fig.height=8, include=FALSE}
ggplot(data = shelterC %>% filter(outcome_type == "Adoption")) +
  geom_bar(mapping = aes(x = `outcome_hour`, fill = `outcome_hour`)) +  scale_fill_manual(values=cbPalette)+
  ggtitle("Distribution of Shelter Outcomes by hour of day") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  theme(plot.title = element_text(hjust = 0.5)) +
  scale_x_continuous(breaks=c(0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23), 
  labels=c("12 am", "1 am", "2 am", "3 am", "4 am", "5 am", "6 am", "7 am", "8 am", "9 am", "10 am", "11 am", 
           "12 pm", "1 pm", "2 pm", "3 pm", "4 pm", "5 pm", "6 pm", "7 pm", "8 pm", "9 pm", "10 pm", "11 pm"))
```

The adoptions tend to peak around 5pm with 6pm following closely behind. This may be related to the time that most salaried adults are off of work. Interestingly we see a fee adoptions between 8 pm and 12 am which was unexpected.

### Month per Year

Taking a look at the intakes over the course of the year. Note that 2013 and 2018 are partial years worth of data, so they have been removed in order to eliminate skew in the data.

```{r plot9, fig.width=10, fig.height=8, include=FALSE}
# Sorting
shelterC$outcome_month <- factor(shelterC$outcome_month, levels = c("1","2","3","4","5","6","7","8","9","10","11","12"))
shelterC$intake_month <- factor(shelterC$intake_month, levels = c("1","2","3","4","5","6","7","8","9","10","11","12"))

ggplot(data = shelterC%>%filter(intake_year != 2013 & intake_year != 2018)) +
  geom_bar(mapping = aes(x = `intake_month`, fill = `intake_month`)) +  
  scale_fill_manual(values=cbPalette)+
  ggtitle("Shelter Intakes by Month of the Year 2014 - 2017") + 
  theme(plot.title = element_text(hjust = 0.5))+ 
  scale_x_discrete(name ="Month of the Year", 
                    labels=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec")) +
  theme(legend.position = 'none')
```

May and June has the highest number of intakes. Probably people had gone for their summer vacations and so had to leave their pets at the shelter home and claim them once they were back.

We can also take a look at the distribution of intakes per animal type each month. 

```{r plot10, fig.width=10, fig.height=8}
ggplot(data = shelterC%>%filter(intake_year != 2013 & intake_year != 2018)) +
  geom_bar(mapping = aes(x = `intake_month`, fill = `animal_type`)) +  scale_fill_manual(values=cbPalette)+
  ggtitle("Shelter Intakes by Month of the Year 2014 - 2017") + 
  theme(plot.title = element_text(hjust = 0.5))+ 
  scale_x_discrete(name ="Month of the Year", 
                    labels=c("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"))
```

The distribution between dogs, cats, other, and birds seems to be fairly consistent across the board. There is no indication that certain months favore one animal type over the other. Though these trends may differ depending on the region in which the animal shelters are located. We must keep in mind that this data is for the Austin animal shelter only.

### Deep Dive into May and June

We take a deeper look into the May and June data to see what type of outcomes were typical during these months as well as the types of intakes the animal shelter had.

```{r table2}
# Create subset of 2015 and June data for 
shelterC_MayJun1516 <- shelterC[(shelterC$intake_year == 2015 & shelterC$intake_month == 6) | (shelterC$intake_month == 5 & (shelterC$intake_year == 2015 | shelterC$intake_year == 2016)),]
# Looking at Ouctome Types in May and June
kable(count(shelterC_MayJun1516,c('outcome_type'))) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
# Looking at Intake Types in May and June
kable(count(shelterC_MayJun1516,c('intake_type'))) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
# Looking at Intake Types in May and June
kable(count(shelterC_MayJun1516[shelterC_MayJun1516$intake_type == 'Owner Surrender' & shelterC_MayJun1516$outcome_type == 'Return to Owner',],c('outcome_type','intake_type'))) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

The results showed that only 48 people took their dogs back. 4884 were found stray during this period which is significant number.

### Most Popular Breed

Seeing as more dogs get adopted than cats we would expect the most popular breed to be a dog breed. The following check will take a look at the top 10 most popular breed regardless of animal type.

```{r table3}
## Dogs over cats assumtion check
breedFreq <- count(shelterC,c('primary_breed'))[order(count(shelterC,c('primary_breed'))$freq,decreasing = TRUE),]
breedFreq <- breedFreq[1:10,]
kable(breedFreq) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

Interestingly the domestic shorthair shows up as the most popular breed, but it is actually really common cat breed not a dog breed. We take a closer look to see if these cat breeds are indeed being adopted very often.

```{r table4}
## Check what happened with them 
kable(count(shelterC[shelterC$primary_breed == 'Domestic Shorthair',],c('outcome_type'))) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

The table above shows that the majority of this breed is transferred then adopted. The large number of transfers is probably why this breed shows up as the most popular, though not necessarily the most popular animal type to adopt.

### Dogs vs Cats

Though the domestic shorthair cat breed is the most popular breed at the animal shelter in terms of total intakes, we can verify that dogs are more popular when it comes to adoptions by segregating the dog and cat adoption numbers and comparing their adoption rate with respect to their total population.

```{r table5}
## Cat vs dog addoption chance

# Dog
DogAdoption <- (count(shelterC[shelterC$animal_type == 'Dog' & (shelterC$outcome_type == 'Adoption' | shelterC$outcome_type == 'Return to Owner'),],c('animal_type'))$freq/count(shelterC[shelterC$animal_type == 'Dog',],c('animal_type'))$freq)*100

# Cat
CatAdoption <- (count(shelterC[shelterC$animal_type == 'Cat' & (shelterC$outcome_type == 'Adoption' | shelterC$outcome_type == 'Return to Owner'),],
                      c('animal_type'))$freq/count(shelterC[shelterC$animal_type == 'Cat',],c('animal_type'))$freq)*100

adoptRate <- data.frame("Animal Type" = c("Dog","Cat"),"Rate" = c(DogAdoption,CatAdoption))

kable(adoptRate) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

## Mean Time in Shelter

An additional question to assess is whether the intake day has any impact on the mean amount of time an animal will spend in the shelter. We calculate the mean duration for weekdays Mon-Thurs and the weekend Fri-Sun.

```{r table6}
## Mean duration the animals stayed in the shelter in which they were returned back to the owner
weekMean <- mean(shelterC[(shelterC$intake_weekday=='Monday' | shelterC$intake_weekday=='Tuesday' | shelterC$intake_weekday=='Wednesday' | shelterC$intake_weekday=='Thursday')  & shelterC$outcome_type == 'Return to Owner',"time_in_shelter_days"])

weekendMean <- mean(shelterC[(shelterC$intake_weekday=='Friday' | shelterC$intake_weekday=='Saturday' | shelterC$intake_weekday=='Sunday') & 
           shelterC$outcome_type == 'Return to Owner',"time_in_shelter_days"])

meanRate <- data.frame("Day Type" = c("Weekday","Weekend"),"Rate" = c(weekMean,weekendMean))

kable(meanRate) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)

```

Here we see there is a slight reduction in mean time in the shelter depending on whether an animal is taken in on a weekend day vs a weekday. However, the difference is marginal at less than 15% of a day and is not considered significant.

So, we'll follow up by seeing if the animal type has an impact on mean time at shelter as well as what outcome type is the primary contributor to their mean times.

```{r plot11, fig.width=10, fig.height=8,include=FALSE}
## Mean time in Shelter By Animal Type
ggplot(data = shelterC, aes(x=animal_type, fill=outcome_type,y=time_in_shelter_days)) + 
  geom_bar(stat = "summary", fun.y = "mean") + 
  scale_fill_manual(values=cbPalette) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Mean time in Shelter by Animal Type") +
  theme(plot.title = element_text(hjust = 0.5))+ 
  ylab("Mean Time in Shelter [Days]") +
  scale_x_discrete(name ="Animal Types", 
                    limits=c("Cat","Dog","Bird","Other"))
```

Overall cats have the longest mean time in the shelter, but interestingly for both cats and dogs, the primary contributor to their mean time in shelter is animals that go missings. However, removing these observations still shows that cats on average spend more time in the shelter than all other animal types.

```{r plot12, fig.width=10, fig.height=8, include=FALSE}
## Mean time in Shelter By Animal Type
ggplot(data = shelterC %>% filter(outcome_type != "Missing"), aes(x=animal_type, fill=outcome_type,y=time_in_shelter_days)) + 
  geom_bar(stat = "summary", fun.y = "mean") + 
  scale_fill_manual(values=cbPalette) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Mean time in Shelter by Animal Type") +
  theme(plot.title = element_text(hjust = 0.5))+ 
  ylab("Mean Time in Shelter [Days]") +
  scale_x_discrete(name ="Animal Types", 
                    limits=c("Cat","Dog","Bird","Other"))
```

### Intake Conditions

We now take a closer look at the condition of the animals during admission to the animal shelter starting with their sex.

```{r table7}
kable(count(shelterC,'sex_upon_intake')) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

Here we see that the majority of admissions were non neutered or spayed animals. We'll now review the method in which these animals were admitted into the shelter.

```{r table8}
kable(count(shelterC,'intake_type')) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

The vast majority of the animals were admitted as strays with owner surrenders being a far second reson for admission. Taking a look at the health of the animals during admission reveals that most were of normal health when admitted followed by sick then injured. But over 70,000 of the 79,661 observations were under normal health conditions.

```{r table9}
kable(count(shelterC,'intake_condition')) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

The following table shows the intakes by animal type and shows the counts plotted in the figure from the Intakes by Animal Type section.

```{r table10}
kable(count(shelterC,'animal_type')) %>%
  kable_styling(bootstrap_options = "striped", full_width = F)
```

These investigations reveal that a majority of the animals that the AAC took in were stray Dogs and Cats. Although most of them were in normal condition, around 4000 were found injured and another 3099 were sick.

### Outcome Types

We now take a look at which day of the week has the most adoptions and other outcome types. The "Distribution of Shelter Outcomes and Day of Week" figure shows that adoptions peak on Saturdays and Sundays, but remain farily consistent on the remaining weekdays ranging from ~3500-4,250 adoptions. The other outcome types take a dip on the weekends and also show consistent levels across weekdays.

```{r plot13, fig.width=10, fig.height=8, include=FALSE}
## Plot outcomes counts faceted by weekday
ggplot(shelterC, aes(x=outcome_type, group=outcome_weekday)) + 
  geom_bar(aes(y = ..count.., fill = factor(..x..)),stat = "count") +
  geom_text(aes(label = scales::comma(..count..),
                y = ..count..), stat = "count", vjust = -.5) + 
  labs(y = "Count of Animals", fill = "outcome_type") + 
  facet_grid(outcome_weekday ~.) + 
  scale_y_continuous(labels = scales::comma, limits = c(0,9000)) +
  scale_fill_manual(values=cbPalette) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Counts by Shelter Outcome and Weekday") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = 'none')

summary(shelterC$time_in_shelter_days)
```

We take a look at this data by viewing a stacked bar chart of the weekdays grouped by outcome types which makes it easier to see the relative distributions of each weekday's contribution to each outcome type.

```{r plot14, fig.width=10, fig.height=8}
## Plot counts of outcomes grouped by date type
ggplot(shelterC, aes(x=outcome_type, fill=outcome_weekday)) + 
  geom_bar() + 
  scale_fill_manual(values=cbPalette) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Distribution of Shelter Outcomes and Day of Week") +
  theme(plot.title = element_text(hjust = 0.5))
```

```{r plot15x, include=FALSE}
## Mean time in Shelter By Outcome Type
# Lastly, we take a look at the impact that each outcome type has on the average time spent in the shelter. The figure below reveals, as previously noted, increased mean times in shelter are skewed by missing animals. On a good note, it appears that animals are returned to owners on average in less than a week.

ggplot(shelterC, aes(x=outcome_type, fill=outcome_type,y=time_in_shelter_days)) + 
  geom_bar(stat = "summary", fun.y = "mean") + 
  scale_fill_manual(values=cbPalette) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Mean time in Shelter by Outcome Type") +
  ylab("Mean Time in Shelter [days]") +
  theme(plot.title = element_text(hjust = 0.5)) +
  theme(legend.position = 'none') +
  scale_x_discrete(name ="Outcome Types", 
                    limits=c("Missing","Adoption","Rto-Adopt","Died","Disposal","Transfer","Euthanasia","Return to Owner","Relocate"))
```

# Predictive Modeling

Animal shelters can face many difficult decisions if a pet cannot be returned to their owner or be chosen for adoption. Scenarios such as limited space to house pets or lack of financial resources can influence a shelter’s decision to either move the pet to a different shelter or worse… euthanasia. If a shelter was able to predict the outcome of a pet, it may ease the decision making process and help put the pet in a more favorable position to get adopted and find their forever home.

Four models will be used to predict the outcomes of the animal with a goal of seeing which variable will lead to higher adoptions rates. These models will be presented in the order listed below.

- Support Vector Machine
- Decision Tree
- Naive Bayes
- Random Forest

## Feature Ranking

Before generating the models we use information Gain function of the RWeka package to rank the features, and show the ranking results. This will help guide the selection of features to use in building the models previously listed.

```{r featRank}
## Turn all variables into factors for analyzing
shelterN <- data.frame(lapply(shelterC, factor))
ig.info <- data.frame(InfoGainAttributeEval(outcome_type ~., data = shelterN))
colnames(ig.info) <-c("IG")
ig.sort <-ig.info[order(-ig.info$IG), , drop=FALSE]
kable(ig.sort)
```

### Time in Shelter

The feature ranking algorithm identified time in shelter as the variable with highest contribution to determine the outcome type, this may be due to the its strong correlation to the missing outcome type and its association with high values for time in shelter. Similarly the adoption outcome type had the next highest number of days in shelter which may again be skewing the association between the outcome type variable and time in shelter days variable.

### Sex upon outcome

Next we see sex_upon_outcome. This may imply that potential adopters prefer for their pets to have already been spayed or neutered. This may also be part of the shelters policy to spay and neuter animals before allowing them to be adopted.

### Primary Breed

The breed of the animal appears to be a big contributor to the outcome type. As we previously say the most popular breed was cat and cats are are generally transfered more than dogs, so this particular breed may predict an outcome of transfer in the models.

### Age Upon Outcome 

The jitter plots show a drop off in adoptions for both dogs and cats after about 15 years. Birds saw a drop off after 2 years. This implies that the age of an animal has an impact as to whether or not it is adopted.

### Other Variables

Further down the list of variables we see Intake Type, Animal Type, Sex_upon_Intake, Outcome_Hour, Primary_Color and others though they do not contribute as strongly as the 4 variables identified above. These additional variables will be selectively included or excluded from the models based on the predictive accuracy of each model and whether or not including the variable improves this accuracy.

## Data Preparation

Before generating the models some discretization of the time based variables is performed to limit the buckets time to 10 based on frequency of occurence. We also split out the spayed or neutered variable from the animal sex.

```{r preProc2}
## Discretize time interval variables
shelterC$time_in_shelter_groups <- discretize(shelterC$time_in_shelter_days, method="cluster", breaks=10)
shelterC$age_upon_intake_groups <- discretize(shelterC$age_upon_intake_.years., method="cluster", breaks=10)
shelterC$age_upon_outcome_groups <- discretize(shelterC$age_upon_outcome_.years., method="cluster", breaks=10)

## Extract the gender and spayed/neutered status for each of the intake and outcome columns
shelterC <- shelterC %>% separate(sex_upon_outcome, 
                c("O_condition", "O_gender"))%>%
             separate(sex_upon_intake, 
                c("I_condition", "I_gender"), remove = TRUE)

```

## SVM

SVMs assume that the data it works with is in a standard range, usually either 0 to 1, or -1 to 1 (roughly). So the normalization of feature vectors prior to feeding them to the SVM is very important.

### SVM - Pre-Processing

We create a subset of the dataset to only include a selection of the predictor variables. Additionally we remove outcome types that we are not interested in leaving only adoption, transfer, euthenasia, and return to owner.

```{r SVMSub}
## Subset data for svm model
shelter_svm <- shelterC %>%
  select(animal_type,outcome_type,intake_month, intake_year, intake_weekday,time_in_shelter_days, age_upon_intake_.years., intake_condition)
shelter_svmm <- shelter_svm[!(shelter_svm$outcome_type=="Died" | 
                           shelter_svm$outcome_type=="Disposal" |
                           shelter_svm$outcome_type=="Missing" |
                           shelter_svm$outcome_type=="Relocate" |
                           shelter_svm$outcome_type=="Rto-Adopt"),]

kable(head(shelter_svmm)) %>% 
  scroll_box(width = "100%")
```

Next since we'll be using an SVM algorithm our categorical values will be converted to numerical values.

```{r SVMgsub}
# Categorize Weekdays
shelter_svmm$intake_weekday <- gsub(".*Mon.*", "1", shelter_svmm$intake_weekday)
shelter_svmm$intake_weekday <- gsub(".*Tue.*", "2", shelter_svmm$intake_weekday)
shelter_svmm$intake_weekday <- gsub(".*Wed.*", "3", shelter_svmm$intake_weekday)
shelter_svmm$intake_weekday <- gsub(".*Thur.*", "4", shelter_svmm$intake_weekday)
shelter_svmm$intake_weekday <- gsub(".*Fri.*", "5", shelter_svmm$intake_weekday)
shelter_svmm$intake_weekday <- gsub(".*Sat.*", "6", shelter_svmm$intake_weekday)
shelter_svmm$intake_weekday <- gsub(".*Sun.*", "7", shelter_svmm$intake_weekday) 

# Categorize Animal Types
shelter_svmm$animal_type <- gsub(".*Cat.*", "1", shelter_svmm$animal_type)
shelter_svmm$animal_type <- gsub(".*Dog.*", "2", shelter_svmm$animal_type)
shelter_svmm$animal_type <- gsub(".*Bird.*", "3", shelter_svmm$animal_type)
shelter_svmm$animal_type <- gsub(".*Other.*", "4", shelter_svmm$animal_type) 

# Categorize Outcome Types
shelter_svmm$outcome_type <- gsub(".*Adoption.*", "1", shelter_svmm$outcome_type)
shelter_svmm$outcome_type <- gsub(".*Euthanasia.*", "2", shelter_svmm$outcome_type)
shelter_svmm$outcome_type <- gsub(".*Return to Owner.*", "3", shelter_svmm$outcome_type)
shelter_svmm$outcome_type <- gsub(".*Transfer.*", "4", shelter_svmm$outcome_type)

# Categorize Intake Conditions
shelter_svmm$intake_condition <- gsub(".*Aged.*", "1", shelter_svmm$intake_condition)
shelter_svmm$intake_condition <- gsub(".*Feral.*", "2", shelter_svmm$intake_condition)
shelter_svmm$intake_condition <- gsub(".*Injured.*", "3", shelter_svmm$intake_condition)
shelter_svmm$intake_condition <- gsub(".*Normal.*", "4", shelter_svmm$intake_condition)
shelter_svmm$intake_condition <- gsub(".*Nursing.*", "5", shelter_svmm$intake_condition)
shelter_svmm$intake_condition <- gsub(".*Pregnant.*", "6", shelter_svmm$intake_condition)
shelter_svmm$intake_condition <- gsub(".*Sick.*", "7", shelter_svmm$intake_condition)
shelter_svmm$intake_condition <- gsub(".*Other.*", "8", shelter_svmm$intake_condition)

# Categorize Intake Years
shelter_svmm$intake_year <- gsub(".*2013.*", "1", shelter_svmm$intake_year)
shelter_svmm$intake_year <- gsub(".*2014.*", "2", shelter_svmm$intake_year)
shelter_svmm$intake_year <- gsub(".*2015.*", "3", shelter_svmm$intake_year)
shelter_svmm$intake_year <- gsub(".*2016.*", "4", shelter_svmm$intake_year)
shelter_svmm$intake_year <- gsub(".*2017.*", "5", shelter_svmm$intake_year)
shelter_svmm$intake_year <- gsub(".*2018.*", "6", shelter_svmm$intake_year)

```

We do futher pre-processing for the SVM and decision tree models. Primarily splitting into training and test sets based on a 75/25 split and cleaning those train and test sets to remove non-zero variance. The outcome types are also extracted from the training and testing sets into their own variables Y_Train and Y_Test.

```{r SVMClean}
## Separate the training label

# 75% of the sample size
smp_size <- floor(0.75 * nrow(shelter_svmm))

## set the seed to make your partition reproducible
set.seed(30521)
train_ind <- sample(seq_len(nrow(shelter_svmm)), size = smp_size)

train <- shelter_svmm[train_ind, ]
Y_train <- as.factor(train$outcome_type)

test <- shelter_svmm[-train_ind, ]
Y_test <- as.factor(test$outcome_type)

## Update the train & test data set
train_data <- train %>% select(-outcome_type) # just keep all the predictor variables only
test_data <- test %>% 
  select(-outcome_type) # keep the predictor variables only

# remove the near zero variance from the train_data & test_data sets
preProc <- preProcess(train_data[-2], method = "nzv")

train_data <- predict(preProc, train_data)
test_data <- predict(preProc, test_data)
```

Next we normalize the numeric values into values between 0 and 1 for the train and test subsets.

```{r SVMNorm}
## Test_data transformation
normalize <- function(input_vect){
   input_vect-min(input_vect)/(max(input_vect)-min(input_vect))
}

## Train data transformation
train_data <- train_data %>% 
  mutate_if(is.numeric, list(normalize)) %>% 
  mutate_if(is.numeric, funs(discretize(., method = "interval", breaks = 10)))

  # fit it in 10 different buckets
kable(head(train_data, n=1)) %>% 
  scroll_box(width = "100%")

## Test_data transformation

test_data <- test_data %>% 
  mutate_if(is.numeric, list(normalize)) %>% 
  mutate_if(is.numeric, funs(discretize(., method = "interval", breaks = 10)))

kable(head(test_data, n=1)) %>% 
  scroll_box(width = "100%")
```

Lastly, we create dummy variables and re-normalize the data for the remaining categorical values.

```{r SVMDummy}
## Dummy code animal_type    
animal_type_df <- shelter_svmm %>% 
    sjmisc::to_dummy(animal_type, suffix = "label")


## Dummy code intake_weekday
intake_weekday_df <- shelter_svmm %>% 
    sjmisc::to_dummy(intake_weekday, suffix = "label")

## Dummy code intake_condition
intake_condition_df <- shelter_svmm %>% 
    sjmisc::to_dummy(intake_condition, suffix = "label")

## Dummy code intake_year
intake_year_df <- shelter_svmm %>% 
    sjmisc::to_dummy(intake_year, suffix = "label")

shelter_svm <- shelter_svmm %>% 
    
    bind_cols(animal_type_df, 
              intake_weekday_df,intake_condition_df, intake_year_df) %>% 
    select(-animal_type, 
           -intake_weekday, -intake_condition, -intake_year)

## Normalize 
preProc <- preProcess(shelter_svmm, method = "range")

## Update the data set
shelter_svmm <- predict(preProc, newdata = shelter_svmm)

kable(head(shelter_svmm)) %>% 
  scroll_box(width = "100%")
set.seed(724)
split_index <- createDataPartition(shelter_svmm$outcome_type, p = 0.8, list=FALSE)
trainset <- shelter_svmm[split_index, ]
testset <- shelter_svmm[-split_index, ]
kable(head(trainset)) %>% 
  scroll_box(width = "100%")
trainset$outcome_type <- as.factor(trainset$outcome_type)
```

### SVM - Model and Tuning

The tune.svm function was used to iterate between cost and gamma values of 0.1, 1.0, and 10. The tune.svm function also applies a 10-fold cross validation procedure to the model.

The optimal parameters based on the variables chosen were

Cost = 10
Gamma = 1

```{r SVMTune, eval = FALSE}
# Tuned SVM with Kernel = Radial
trainset$outcome_type <- as.factor(trainset$outcome_type)
testset$outcome_type <- as.factor(testset$outcome_type)


## Tuning 
set.seed(30521)
tune_out <- tune.svm(outcome_type~., data = trainset,
                     type = "C-classification",
                     kernel = "radial",
                     cost = c(0.1, 1, 10),
                     gamma = c(0.1, 1, 10))


# print out the best tuned parameters
tune_out$best.parameters$cost
tune_out$best.parameters$gamma

# build the optimal model
set.seed(30521)
svm_optimal <- svm(outcome_type ~., data = trainset,
                  type = "C-classification",
                  kernel = "radial",
                  cost = tune_out$best.parameters$cost,
                  gamma = tune_out$best.parameters$gamma)

svm_optimal_pred <- predict(svm_optimal, testset)

# confusion matrix
caret::confusionMatrix(table(svm_optimal_pred, 
                       testset$outcome_type))

```

The optimal SVM model was then built using the cost and gamma values previously identified.

```{r, echo = FALSE}
svm_optimal_2 <- readRDS("./svm_optimal_2_R00.RDS")
```
```{r SVMModel, eval=FALSE}
# Build Optimal SVM Model
svm_optimal_2 <- svm(outcome_type ~., data = trainset,
                  type = "C-classification",
                  kernel = "radial",
                  cost = 10,
                  gamma = 1)

saveRDS(svm_optimal_2, "./svm_optimal_2_R00.rds")
```
```{r SVMPred, eval=FALSE}
# Predictions for Testset
set.seed(30521)
svm_optimal_pred_2 <- predict(svm_optimal_2, testset[-2])

# Save Predictions to CSV
write.table(svm_optimal_pred_2, file = "./svm_optimal_pred_2.csv", sep = ",")
```
```{r SVMConf}
# Load Predictions from CSV
svm_pred <- read_csv("./svm_optimal_pred_2.csv")

# confusion matrix
caret::confusionMatrix(table(svm_pred$pred, 
                       testset$outcome_type))
```

The confusion matrix shows an accuracy of 65.58% and varying levels of specificiy and sensitivity. The accuracy is better than randomly selecting 1 of 4 potential outcomes or a 25% accuracy and also better than selecting the most probable outcome of Adoption at 42%. We'll try out a few more models to see if we can improve the predictive accuracy.

## Decision Tree

A decision tree was built using the normalized train and test dataset along with removal of near zero variance values. The full tree was first built and post prunned at cp = 0, 0.1, 0.001, 0.0001 and 0.00001. Ultimately the cp of .0001 showed the best improvement in model accuracy.

```{r decTree, fig.width=10, fig.height=8}
## Decision tree model
decTreeTrain <- rpart(outcome_type ~ ., data = trainset, method = 'class', 
                      control = rpart.control(cp = 0), minsplit = 25, maxdepth = 5)

# visualize the full tree
# rpart.plot(decTreeTrain, box.palette="RdBu", shadow.col="gray", nn=TRUE)

## Testing the accuracy of the tree on the training t
trainPred <- predict(decTreeTrain, trainset[-2], type = "class")

# Confusion Matrix for Train Set
caret::confusionMatrix(table(data = trainPred,
                       reference = trainset$outcome_type))

## Testing the accuracy of the tree on the training t
testPred <- predict(decTreeTrain, testset[-2], type = "class")

# Confusion Matrix for Train Set
caret::confusionMatrix(table(data = testPred,
                       reference = testset$outcome_type))

# Prune Model 4 - Best
post_pruned_4 <- prune(decTreeTrain, cp=0.0001)
testPred_4 <- predict(post_pruned_4, testset[-2], type = "class")
caret::confusionMatrix(table(data = testPred_4,
                       reference = testset$outcome_type))

# Plot best decision tree model
rpart.plot(post_pruned_4, box.palette="RdBu", shadow.col="gray", nn=TRUE)
```

The best accuracy was 70.94% which is an improvement over the best SVM model. The Sensitivity and Specificity values are similar to those from the SVM model and particularly bad for the 4th calssification as was the case for the SVM model as well.

## Naive Bayes

A Naive Bayes algorithm based model was attempted, but showed the worst performance of all models generatred. The default values were used as a first pass, but due to its poor performance no further tuning efforts were attempted.

```{r NB}
## Build the classifier
nbTrain <- naiveBayes(Y_train ~ ., data = train_data)

# Test the results on the train set 
nbTrainPred <- predict(nbTrain, train_data, type = 'class')
confusionMatrix(nbTrainPred, Y_train)

# Test it against the test set and check the results  

nbTestPred <- predict(nbTrain, test_data, type = 'class')
confusionMatrix(nbTestPred, Y_test)
```

The accuracy of the test dataset was 48.94% which is marginally better than selecting Adoption as the outcome type for all observations. Additionally the sensitivity and specificity values for all classes show the worst balance of all models with class 3 showing a sensitivity value of 0.04.

## Random Forest

The random forest model was run using the default ntree setting of 500 and showed the best performance of all models. A second run was attempted at ntree = 800, but did not show any improvement in accuracy. As the ntree = 800 model took longer to run than the ntree = 500 model and showed no improvement, the ntree parameter was reset to 500.

```{r}
library(randomForest)

# We'll set the seed to assure reproducibility.
set.seed(30521)

# Build Random Forrest Model
rf_model <- randomForest(outcome_type~.,
                        data=trainset,
                        ntree = 500,     ## specify the number of trees to grow
                        importance=TRUE) ## this is used to inspect variable importance

# print(rf_model)
rf_model

# print variable importance
varImpPlot(rf_model)
```

The variable importance plot above is consistent with the feature ranking table with regards to the most important variable time_in_shelter_days. Other similar variables include animal_type, age_upon_intake_years and intake_condition though these variables are deemed more important to the random forest model than the information gained fuction from RWeka.

### Random Forest Prediction

Predictions are made using the testset and the random forest model based on ntree = 500.

```{r}
set.seed(30521)
rf_model_prediction <- predict(rf_model, newdata = testset[-2])

# confusion matrix
caret::confusionMatrix(data = rf_model_prediction,
                       reference = as.factor(testset$outcome_type))
```

The prediction of the random forest model produces the best accuracy of all at 72.9% and better balance between sensitivity and specificity. The classification for group 4 still proves to be troublesome for sensitivity with a value of 0.5631 and we do see in the confusion matrix that 778 instances of this class are mis-classified acros groups 1, 2, and 3. This is about 22.5% of all observations in class 4. Class 1, adoptions has the best performance across sensitivity and specificity, but this may be simply due to the fact that it has the greatest amount of observations and is less impacted by mis-classifications.

# Conclusion

Based on the models evaluated, the random forest algorithm presente the best accuracy at 73% which is significantly better than random chance and selecting the most probable outcome. Based on this model and its rating of variable importance we can see that time spent in the shelter has a strong link to animal outcomes. However we cannot make an argument that animals spending more or less time in the shelter will lead to higher adoptions. So we must rely on other variables such as animal_type and age. Here we can see a better link between the characteristics of the animal and the outcome. 

Focusing on these variables is supported by the exploratory analysis that shows dogs are generally adopted in greater numbers than cats and that both cats and dogs see a significant drop off in adoptions after 15 years. 

Areas for future improvement of these models include grouping common breeds and gathering additional data across multiple animal shelters as there may be a geographical component over which pets are popular in certain regions. This could lead to additional recommendations regarding where to transfer cats in order to imporove their adoption rates.
